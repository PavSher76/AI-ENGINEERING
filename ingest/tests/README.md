# E2E Тесты для модуля "Объекты-аналоги и Архив"

## Обзор

Этот набор тестов проверяет функциональность гибридного поиска, поиска аналогов оборудования, поиска узлов P&ID и сравнения BoM.

## Структура тестов

### test_analog_search.py
Тесты для поиска аналогов оборудования:
- Поиск центробежных насосов
- Поиск теплообменников
- Поиск компрессоров
- Поиск арматуры
- Тестирование весов гибридного поиска
- Поиск с фильтрами
- Скоринг релевантности

### test_pid_search.py
Тесты для поиска узлов P&ID:
- Поиск реакторов
- Поиск теплообменников
- Поиск насосов
- Поиск компрессоров
- Поиск регулирующих клапанов
- Поиск приборов КИПиА
- Поиск по тегам оборудования
- Поиск по технологическому потоку
- Поиск по системам управления

### test_bom_comparison.py
Тесты для сравнения BoM:
- Поиск насосов в BoM
- Поиск теплообменников в BoM
- Поиск компрессоров в BoM
- Поиск арматуры в BoM
- Поиск приборов КИПиА в BoM
- Сравнение материалов
- Сравнение поставщиков
- Сравнение количеств
- Сравнение стандартов
- Сравнение параметров

## Запуск тестов

### Предварительные требования

1. Убедитесь, что все сервисы запущены:
   ```bash
   cd /path/to/ingest
   docker-compose up -d
   ```

2. Установите зависимости:
   ```bash
   pip install -r requirements.txt
   ```

### Запуск отдельных тестов

```bash
# Тесты поиска аналогов
python tests/e2e/test_analog_search.py

# Тесты поиска P&ID
python tests/e2e/test_pid_search.py

# Тесты сравнения BoM
python tests/e2e/test_bom_comparison.py
```

### Запуск всех тестов

```bash
# Запуск всех E2E тестов
python -m pytest tests/e2e/ -v
```

## Ожидаемые результаты

### Поиск аналогов
- ✅ Находит центробежные насосы по описанию
- ✅ Находит теплообменники по типу и параметрам
- ✅ Находит компрессоры по характеристикам
- ✅ Находит арматуру по типу и размерам
- ✅ Правильно взвешивает результаты BM25 + Dense + Rerank
- ✅ Фильтрует результаты по дисциплинам
- ✅ Сортирует по релевантности

### Поиск P&ID
- ✅ Находит реакторы по тегам и описанию
- ✅ Находит теплообменники по функциям
- ✅ Находит насосы по назначению
- ✅ Находит компрессоры по параметрам
- ✅ Находит регулирующие клапаны по типу
- ✅ Находит приборы КИПиА по функциям
- ✅ Поиск по тегам оборудования
- ✅ Поиск по технологическим потокам
- ✅ Поиск по системам управления

### Сравнение BoM
- ✅ Находит оборудование в BoM по типу
- ✅ Сравнивает материалы (нержавеющая сталь, углеродистая сталь)
- ✅ Сравнивает поставщиков (Sulzer, Alfa Laval, Atlas Copco, Velan, Emerson)
- ✅ Сравнивает количества оборудования
- ✅ Сравнивает стандарты (API 610, API 617, API 600, TEMA)
- ✅ Сравнивает параметры (производительность, давление, температура)

## Отладка

### Логи
Тесты выводят подробные логи о процессе поиска:
- Количество найденных результатов
- Скоринг релевантности
- Содержимое найденных документов
- Метаданные результатов

### Типичные проблемы

1. **Сервисы не запущены**
   - Убедитесь, что Qdrant, Meilisearch, PostgreSQL запущены
   - Проверьте подключение к сервисам

2. **Модели не загружены**
   - BGE-M3 модель загружается при первом запуске
   - Убедитесь в наличии интернет-соединения

3. **Низкая релевантность**
   - Проверьте качество тестовых данных
   - Убедитесь в правильности векторизации

## Расширение тестов

### Добавление новых тестов

1. Создайте новый файл теста в `tests/e2e/`
2. Наследуйтесь от базового класса тестов
3. Добавьте тестовые данные в фикстуры
4. Реализуйте тестовые методы
5. Добавьте запуск в `run_tests()`

### Добавление новых типов оборудования

1. Обновите `equipment_taxonomy.json`
2. Добавьте тестовые данные
3. Создайте соответствующие тесты
4. Проверьте векторизацию и поиск

## Производительность

### Ожидаемые времена выполнения
- Поиск аналогов: < 2 секунд
- Поиск P&ID: < 1.5 секунд  
- Сравнение BoM: < 1 секунда

### Оптимизация
- Используйте фильтры для ускорения поиска
- Ограничивайте количество результатов
- Кешируйте результаты для повторных запросов
