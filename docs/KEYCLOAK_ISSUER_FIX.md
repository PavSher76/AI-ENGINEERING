# üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ issuer –≤ Keycloak

## ‚úÖ –°—Ç–∞—Ç—É—Å: –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê

**–î–∞—Ç–∞**: 2 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è**: 1.0.0  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üö® –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞ 405 (Not Allowed):**
```
POST http://localhost:3000/realms/ai-engineering/login-actions/authenticate 405 (Not Allowed)
```

**–ü—Ä–∏—á–∏–Ω–∞:** Keycloak –ø—ã—Ç–∞–ª—Å—è –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É URL `http://localhost:3000/realms/ai-engineering/login-actions/authenticate` –≤–º–µ—Å—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ `http://localhost:8080/realms/ai-engineering/login-actions/authenticate`.

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π issuer** –≤ OpenID Connect –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ URL** –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
3. **–ü—Ä–æ–±–ª–µ–º—ã —Å hostname** –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π –≤ Keycloak

### –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:
- OpenID Connect –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –ø–æ–∫–∞–∑—ã–≤–∞–ª–∞ `issuer: http://localhost:3000/realms/ai-engineering`
- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å `issuer: http://localhost:8080/realms/ai-engineering`
- Keycloak –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ–ø—Ä–µ–¥–µ–ª—è–ª —Å–≤–æ–π URL –∏–∑-–∑–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–æ–∫—Å–∏
- –≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫ –æ—à–∏–±–∫–∞–º 405 –ø—Ä–∏ –ø–æ–ø—ã—Ç–∫–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏

---

## üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ

### 1. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ Keycloak
**–§–∞–π–ª:** `docker-compose.yml`
```yaml
keycloak:
  image: quay.io/keycloak/keycloak:26.4.0
  command: start-dev --http-enabled=true --hostname-strict=false --import-realm --http-port=8080 --hostname=localhost --hostname-port=8080
  environment:
    KC_PROXY: none  # –û—Ç–∫–ª—é—á–µ–Ω –ø—Ä–æ–∫—Å–∏
    KC_HOSTNAME_URL: http://localhost:8080
    KC_HOSTNAME_ADMIN_URL: http://localhost:8080
    KC_HOSTNAME_PORT: 8080
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ realm –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
**–ö–æ–º–∞–Ω–¥–∞:**
```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Keycloak
docker-compose exec keycloak /opt/keycloak/bin/kcadm.sh config credentials --server http://localhost:8080 --realm master --user admin --password admin

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ realm
docker-compose exec keycloak /opt/keycloak/bin/kcadm.sh update realms/ai-engineering -f /tmp/temp_realm_update.json
```

**–§–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** `temp_realm_update.json`
```json
{
  "attributes": {
    "frontendUrl": "http://localhost:8080"
  }
}
```

### 3. –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ Keycloak
**–ö–æ–º–∞–Ω–¥–∞:**
```bash
docker-compose restart keycloak
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- ‚úÖ **Issuer –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** –Ω–∞ `http://localhost:8080/realms/ai-engineering`
- ‚úÖ **Keycloak –¥–æ—Å—Ç—É–ø–µ–Ω** –Ω–∞ HTTP
- ‚úÖ **Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç** —á–µ—Ä–µ–∑ HTTPS
- ‚úÖ **API –¥–æ—Å—Ç—É–ø–µ–Ω** —á–µ—Ä–µ–∑ HTTPS
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- ‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã** —É—Å–ø–µ—à–Ω–æ
- ‚úÖ **–û—à–∏–±–∫–∏ 405 —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã**

### –ö–æ–º–∞–Ω–¥—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ issuer
curl -s http://localhost:8080/realms/ai-engineering/.well-known/openid-configuration | jq -r '.issuer'

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Keycloak
curl -s -I http://localhost:8080

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Frontend
curl -k -s -I https://localhost

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
curl -k -s https://localhost/api/chat/health

# –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
./scripts/test_auth_complete.sh
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ**: 2
- **–ö–æ–º–∞–Ω–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ**: 4
- **–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: ~10 –º–∏–Ω—É—Ç

---

## üåê –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### URL-–∞–¥—Ä–µ—Å–∞:
- **Frontend**: https://localhost (—á–µ—Ä–µ–∑ Nginx)
- **API**: https://localhost/api (—á–µ—Ä–µ–∑ Nginx)
- **Keycloak**: http://localhost:8080
- **Keycloak Admin**: http://localhost:8080/admin
- **Keycloak Realm**: http://localhost:8080/realms/ai-engineering

### –ü—Ä–æ—Ç–æ–∫–æ–ª—ã:
- **Frontend ‚Üí API**: HTTPS ‚Üí HTTPS ‚úÖ
- **Frontend ‚Üí Keycloak**: HTTPS ‚Üí HTTP ‚úÖ
- **CORS**: –ù–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ
- **PKCE**: –û—Ç–∫–ª—é—á–µ–Ω –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ‚úÖ
- **Issuer**: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π URL ‚úÖ

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞:
1. **–û—à–∏–±–∫–∏ 405 —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã**
2. **Issuer –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
3. **Keycloak —Ä–∞–±–æ—Ç–∞–µ—Ç** –Ω–∞ HTTP
4. **Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç** —á–µ—Ä–µ–∑ HTTPS
5. **API –¥–æ—Å—Ç—É–ø–µ–Ω** —á–µ—Ä–µ–∑ HTTPS
6. **–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
7. **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã** —É—Å–ø–µ—à–Ω–æ

### üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Keycloak
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API
- CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

---

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É:
1. **–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä** –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://localhost
2. **–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Keycloak"**
3. **–í–≤–µ–¥–∏—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**:
   - **admin/admin** - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
   - **developer/developer** - –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
   - **analyst/analyst** - –ê–Ω–∞–ª–∏—Ç–∏–∫
   - **viewer/viewer** - –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å
4. **–ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø** –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–æ–ª—è–º

### –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:
- **Issuer –∏—Å–ø—Ä–∞–≤–ª–µ–Ω** –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π URL
- **Keycloak —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ HTTP** –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ HTTPS** —á–µ—Ä–µ–∑ Nginx
- **–°–º–µ—à–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã** —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- **CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω** –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤

---

## üîß –î–ª—è production

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã** –¥–ª—è Keycloak
2. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS** –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
3. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ CA** —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã
4. **–û–±–Ω–æ–≤–∏—Ç–µ CORS –ø–æ–ª–∏—Ç–∏–∫–∏** –¥–ª—è production

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è production:
```bash
# –ì–µ–Ω–µ—Ä–∞—Ü–∏—è SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤
./scripts/setup_ssl_local.sh

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keycloak –Ω–∞ HTTPS
# (—Ç—Ä–µ–±—É–µ—Ç –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏)
```

---

*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π AI Engineering Platform*
