# üîê –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–∫–∏ PKCE –≤ Keycloak

## ‚úÖ –°—Ç–∞—Ç—É—Å: –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê

**–î–∞—Ç–∞**: 2 –æ–∫—Ç—è–±—Ä—è 2025  
**–í–µ—Ä—Å–∏—è**: 1.0.0  
**–°—Ç–∞—Ç—É—Å**: ‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ

---

## üö® –ò—Å—Ö–æ–¥–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞

**–û—à–∏–±–∫–∞ PKCE:**
```
Keycloak —Å–æ–±—ã—Ç–∏–µ: onAuthError {error: 'invalid_request', error_description: 'Missing+parameter%3A+code_challenge_method'}
–û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏: {error: 'invalid_request', error_description: 'Missing+parameter%3A+code_challenge_method'}
```

**–ü—Ä–∏—á–∏–Ω–∞:** Keycloak –∫–ª–∏–µ–Ω—Ç –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ PKCE (Proof Key for Code Exchange), –Ω–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã.

---

## üîç –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–±–ª–µ–º—ã

### –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã:
1. **–û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–π PKCE** –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –∫–ª–∏–µ–Ω—Ç–∞ Keycloak
2. **–ù–µ—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏** –º–µ–∂–¥—É –∫–ª–∏–µ–Ω—Ç–æ–º –∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º
3. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ code_challenge_method** –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

### –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑:
- –í Keycloak –∫–ª–∏–µ–Ω—Ç–µ –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∞—Ç—Ä–∏–±—É—Ç `pkce.code.challenge.method: S256`
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –±—ã–ª –Ω–∞—Å—Ç—Ä–æ–µ–Ω –Ω–∞ `pkceMethod: 'S256'`
- –ù–æ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª—è–ª `code_challenge_method` –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö
- Keycloak –æ—Ç–∫–ª–æ–Ω—è–ª –∑–∞–ø—Ä–æ—Å—ã –∏–∑-–∑–∞ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ–≥–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞

---

## üõ†Ô∏è –†–µ—à–µ–Ω–∏–µ

### 1. –û—Ç–∫–ª—é—á–µ–Ω–∏–µ PKCE –≤ Keycloak –∫–ª–∏–µ–Ω—Ç–µ
**–ö–æ–º–∞–Ω–¥–∞:**
```bash
# –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Keycloak
docker-compose exec keycloak /opt/keycloak/bin/kcadm.sh config credentials --server http://localhost:8080 --realm master --user admin --password admin

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–∞
docker-compose exec keycloak /opt/keycloak/bin/kcadm.sh update clients/ai-frontend-client -r ai-engineering -f /tmp/temp_client_update.json
```

**–§–∞–π–ª –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:** `temp_client_update.json`
```json
{
  "attributes": {
    "pkce.code.challenge.method": ""
  }
}
```

### 2. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
**–§–∞–π–ª:** `frontend/src/services/keycloak.ts`
```typescript
// –ë—ã–ª–æ:
const initOptions = {
  onLoad: 'check-sso',
  silentCheckSsoRedirectUri: window.location.origin + '/silent-check-sso.html',
  pkceMethod: 'S256',  // ‚Üê –£–¥–∞–ª–µ–Ω–æ
  checkLoginIframe: false,
  enableLogging: true,
};

// –°—Ç–∞–ª–æ:
const initOptions = {
  onLoad: 'check-sso',
  silentCheckSsoRedirectUri: window.location.origin + '/silent-check-sso.html',
  checkLoginIframe: false,
  enableLogging: true,
};
```

### 3. –ü–µ—Ä–µ—Å–±–æ—Ä–∫–∞ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
**–ö–æ–º–∞–Ω–¥–∞:**
```bash
docker-compose up -d --build frontend
```

---

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- ‚úÖ **Keycloak –¥–æ—Å—Ç—É–ø–µ–Ω** –Ω–∞ HTTP
- ‚úÖ **Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç** —á–µ—Ä–µ–∑ HTTPS
- ‚úÖ **API –¥–æ—Å—Ç—É–ø–µ–Ω** —á–µ—Ä–µ–∑ HTTPS
- ‚úÖ **–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
- ‚úÖ **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã** —É—Å–ø–µ—à–Ω–æ
- ‚úÖ **PKCE –æ—à–∏–±–∫–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã**

### –ö–æ–º–∞–Ω–¥—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
```bash
# –ü—Ä–æ–≤–µ—Ä–∫–∞ Keycloak
curl -s -I http://localhost:8080

# –ü—Ä–æ–≤–µ—Ä–∫–∞ Frontend
curl -k -s -I https://localhost

# –ü—Ä–æ–≤–µ—Ä–∫–∞ API
curl -k -s https://localhost/api/chat/health

# –ü–æ–ª–Ω—ã–π —Ç–µ—Å—Ç –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
./scripts/test_auth_complete.sh
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

- **–§–∞–π–ª–æ–≤ –∏–∑–º–µ–Ω–µ–Ω–æ**: 2
- **–°—Ç—Ä–æ–∫ –∫–æ–¥–∞ —É–¥–∞–ª–µ–Ω–æ**: 1
- **–ö–æ–º–∞–Ω–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ**: 4
- **–í—Ä–µ–º—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è**: ~15 –º–∏–Ω—É—Ç

---

## üåê –§–∏–Ω–∞–ª—å–Ω–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

### URL-–∞–¥—Ä–µ—Å–∞:
- **Frontend**: https://localhost (—á–µ—Ä–µ–∑ Nginx)
- **API**: https://localhost/api (—á–µ—Ä–µ–∑ Nginx)
- **Keycloak**: http://localhost:8080
- **Keycloak Admin**: http://localhost:8080/admin

### –ü—Ä–æ—Ç–æ–∫–æ–ª—ã:
- **Frontend ‚Üí API**: HTTPS ‚Üí HTTPS ‚úÖ
- **Frontend ‚Üí Keycloak**: HTTPS ‚Üí HTTP ‚úÖ
- **CORS**: –ù–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ ‚úÖ
- **PKCE**: –û—Ç–∫–ª—é—á–µ–Ω –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏ ‚úÖ

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

### ‚úÖ –ü—Ä–æ–±–ª–µ–º–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ—à–µ–Ω–∞:
1. **PKCE –æ—à–∏–±–∫–∏ —É—Å—Ç—Ä–∞–Ω–µ–Ω—ã**
2. **Keycloak —Ä–∞–±–æ—Ç–∞–µ—Ç** –Ω–∞ HTTP
3. **Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç** —á–µ—Ä–µ–∑ HTTPS
4. **API –¥–æ—Å—Ç—É–ø–µ–Ω** —á–µ—Ä–µ–∑ HTTPS
5. **–°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏** —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∏—Ä—É–µ—Ç
6. **–í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ–π–¥–µ–Ω—ã** —É—Å–ø–µ—à–Ω–æ

### üöÄ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥—É—Ç –≤—Ö–æ–¥–∏—Ç—å —á–µ—Ä–µ–∑ Keycloak
- –§—Ä–æ–Ω—Ç–µ–Ω–¥ –º–æ–∂–µ—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ API
- CORS –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –í—Å–µ —Å–µ—Ä–≤–∏—Å—ã —Ä–∞–±–æ—Ç–∞—é—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ

---

## üìã –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–∏—Å—Ç–µ–º—É:
1. **–û—Ç–∫—Ä–æ–π—Ç–µ –±—Ä–∞—É–∑–µ—Ä** –∏ –ø–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞ https://localhost
2. **–ù–∞–∂–º–∏—Ç–µ "–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Keycloak"**
3. **–í–≤–µ–¥–∏—Ç–µ —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ**:
   - **admin/admin** - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
   - **developer/developer** - –†–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫
   - **analyst/analyst** - –ê–Ω–∞–ª–∏—Ç–∏–∫
   - **viewer/viewer** - –ù–∞–±–ª—é–¥–∞—Ç–µ–ª—å
4. **–ü–æ–ª—É—á–∏—Ç–µ –¥–æ—Å—Ç—É–ø** –∫ —Ñ—É–Ω–∫—Ü–∏—è–º —Å–æ–≥–ª–∞—Å–Ω–æ —Ä–æ–ª—è–º

### –í–∞–∂–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è:
- **PKCE –æ—Ç–∫–ª—é—á–µ–Ω** –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **Keycloak —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ HTTP** –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
- **Frontend —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ HTTPS** —á–µ—Ä–µ–∑ Nginx
- **–°–º–µ—à–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ç–æ–∫–æ–ª—ã** —Ä–∞–±–æ—Ç–∞—é—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üîß –î–ª—è production

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
1. **–í–∫–ª—é—á–∏—Ç–µ PKCE** –¥–ª—è production
2. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ SSL —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã** –¥–ª—è Keycloak
3. **–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ HTTPS** –¥–ª—è –≤—Å–µ—Ö —Å–µ—Ä–≤–∏—Å–æ–≤
4. **–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ CA** —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã

### –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è PKCE:
```bash
# –í–∫–ª—é—á–µ–Ω–∏–µ PKCE –≤ Keycloak
docker-compose exec keycloak /opt/keycloak/bin/kcadm.sh update clients/ai-frontend-client -r ai-engineering -s 'attributes.pkce.code.challenge.method=S256'

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞
# –î–æ–±–∞–≤–∏—Ç—å pkceMethod: 'S256' –≤ initOptions
```

---

*–û—Ç—á–µ—Ç —Å–æ–∑–¥–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π AI Engineering Platform*
